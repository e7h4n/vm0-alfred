name: Run Alfred

on:
  workflow_dispatch:
    inputs:
      recording_id:
        description: 'Recording ID from voice input'
        required: true
      api_key:
        description: 'API key for authentication'
        required: true
      docs_url:
        description: 'Documentation URL'
        required: true

jobs:
  run-alfred:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write
    steps:
      - name: Run Alfred Agent
        id: vm0
        uses: vm0-ai/run-action@v1
        with:
          agent: alfred
          prompt: "recording_id: ${{ github.event.inputs.recording_id }} api_key: ${{ github.event.inputs.api_key }} docs_url: ${{ github.event.inputs.docs_url }}"
          session-id: ${{ vars.VM0_SESSION_ID }}
          vm0-token: ${{ secrets.VM0_TOKEN }}
          secrets: |
            CLAUDE_CODE_OAUTH_TOKEN=${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
            ELEVENLABS_API_KEY=${{ secrets.ELEVENLABS_API_KEY }}
            OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
            FIRECRAWL_API_KEY=${{ secrets.FIRECRAWL_API_KEY }}
            NOTION_API_KEY=${{ secrets.NOTION_API_KEY }}
            PLAUSIBLE_API_KEY=${{ secrets.PLAUSIBLE_API_KEY }}
            SLACK_BOT_TOKEN=${{ secrets.SLACK_BOT_TOKEN }}
            GITHUB_TOKEN=${{ secrets.GH_TOKEN }}
            PUSHINATOR_API_KEY=${{ secrets.PUSHINATOR_API_KEY }}
            MINIMAX_API_KEY=${{ secrets.MINIMAX_API_KEY }}
            APIFY_API_TOKEN=${{ secrets.APIFY_API_TOKEN }}
            SUPABASE_SECRET_KEY=${{ secrets.SUPABASE_SECRET_KEY }}
          vars: |
            PLAUSIBLE_SITE_ID=${{ vars.PLAUSIBLE_SITE_ID }}
            SUPABASE_URL=${{ vars.SUPABASE_URL }}
            SUPABASE_PUBLISHABLE_KEY=${{ vars.SUPABASE_PUBLISHABLE_KEY }}
      - name: Save session ID
        if: steps.vm0.outputs.session-id != ''
        env:
          GH_TOKEN: ${{ secrets.GH_ALFRED_VAR_TOKEN }}
        run: gh variable set VM0_SESSION_ID --body "${{ steps.vm0.outputs.session-id }}" --repo ${{ github.repository }}
